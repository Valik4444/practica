<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Curs Valutar</title>

    <!-- Bootstrap -->
    <link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
    	.well-curs {
        margin-top: 30px;
    	}
    </style> 
  </head>
  <body>
    
  	<div class="container">
	    <div class="row">
	    	<div class="col-md-12">
	    		<div class="well well-curs">  
	    			
            <div class="row">
              <div class="col-sm-4">
                MDL
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_MDL" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
                USD
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_USD" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
                EUR
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_EUR" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
               RUB
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_RUB" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
                RON
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_RON" placeholder="1000">
                </div>
              </div>
            </div>

	    		</div>
	    	</div>
	    </div>
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../node_modules/gasparesganga-jquery-loading-overlay/dist/loadingoverlay.min.js"></script>    
    <script src="../node_modules/localforage/dist/localforage.min.js"></script>      
    <script type="text/javascript">
      $(document).ready(function()
      {
        function populateData(datas) {
          var allEl = $('[id^="curs_"]');
          $.each(allEl, function( index, value ) {
            //alert( index + ": " + value );
            var elID = $(this).attr('id');
            //console.log(elID);
            if (elID.indexOf("USD") >= 0) {
              $("#curs_USD").val(datas.USD);
            }
            if (elID.indexOf("EUR") >= 0) {
              $("#curs_EUR").val(datas.EUR);
            }
            if (elID.indexOf("RUB") >= 0) {
              $("#curs_RUB").val(datas.RUB);
            }
            if (elID.indexOf("RON") >= 0) {
              $("#curs_RON").val(datas.RON);
            }
          });

        }

        function GetDataFromUninorte(successCallback, errorCallback) {
            $('html').LoadingOverlay("show");
            $.ajax({
              type: "GET",
              url: "https://cors-anywhere.herokuapp.com/https://bnm.md/ro/official_exchange_rates?get_xml=1&date=10.04.2019",
              dataType: "xml",
              success: mySuccessCallback,
              error: myErrorCallback
            });
        }

        function mySuccessCallback(successResponse) {
            console.log('callback:success', successResponse);
            $(successResponse).find('Valute').each(function(){
              var CharCode = $(this).find('CharCode').text();
              if ((CharCode == "EUR") || (CharCode == "USD") || (CharCode == "RUB") || (CharCode == "RON")) {
                var Value = $(this).find('Value').text();

                selectedValue[ CharCode ] = Value;

              }
            });

            //console.log("Date dupa succes");
            console.log(selectedValue);
            populateData(selectedValue);
            localforage.setItem('cursValutar', successResponse).then(function (value) {
                // Do other things once the value has been saved.
                console.log('Cache local salvat');
                console.log(value);
            }).catch(function(err) {
                // This code runs if there were any errors
                console.log('Cache local - eroare la salvare');
                console.log(err);
            });
            $('html').LoadingOverlay("hide", true);
        }
        function myErrorCallback(successResponse) {
            console.log('callback:success', successResponse);
            GetDataFromUninorte(mySuccessCallback, myErrorCallback);
        }
        // GetDataFromUninorte(mySuccessCallback, myErrorCallback);


        var selectedValue = {};

        localforage.getItem('cursValutar').then(function(value) {
            // This code runs once the value has been loaded
            // from the offline store.
            console.log('Datele in cache exista');
            if (value == null) {
              GetDataFromUninorte(mySuccessCallback, myErrorCallback);
            }
            console.log(value);
        }).catch(function(err) {
            // This code runs if there were any errors
            console.log('Datele in cache NU exista.Le luam de la BNM...');
            console.log(err);
            GetDataFromUninorte(mySuccessCallback, myErrorCallback);
        });

        
        // log all IF doc ready remote data
        //console.log("doc ready");
      });
    </script>
  </body>
</html>