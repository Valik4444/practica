<!DOCTYPE html>
<html lang="ro">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Curs Valutar</title>

    <!-- Bootstrap -->
    <link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
    	.well-curs {
        margin-top: 30px;
    	}
    </style> 
  </head>
  <body>
    
  	<div class="container">
	    <div class="row">
	    	<div class="col-md-12">
	    		<div class="well well-curs">  
	    			
            <div class="row">
              <div class="col-sm-4">
                MDL
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_MDL" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
                USD
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_USD" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
                EUR
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_EUR" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
               RUB
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_RUB" placeholder="1000">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-sm-4">
                RON
              </div>
              <div class="col-sm-8">
                <div class="form-group">
                  <input type="text" class="form-control" id="curs_RON" placeholder="1000">
                </div>
              </div>
            </div>

	    		</div>
	    	</div>
	    </div>
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../node_modules/jquery/dist/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../node_modules/gasparesganga-jquery-loading-overlay/dist/loadingoverlay.min.js"></script>    
    <script src="../node_modules/localforage/dist/localforage.min.js"></script>      
    <script type="text/javascript">
      $(document).ready(function()
      {
        // transforma datele din XML in text
        function XMLToString(oXML)
        {
         //code for IE
         if (window.ActiveXObject) {
         var oString = oXML.xml; return oString;
         } 
         // code for Chrome, Safari, Firefox, Opera, etc.
         else {
         return (new XMLSerializer()).serializeToString(oXML);
         }
         }

         // transforma datele din TEXT in xml
        function StringToXML(oString) {
         //code for IE
         if (window.ActiveXObject) { 
         var oXML = new ActiveXObject("Microsoft.XMLDOM"); oXML.loadXML(oString);
         return oXML;
         }
         // code for Chrome, Safari, Firefox, Opera, etc. 
         else {
         return (new DOMParser()).parseFromString(oString, "text/xml");
         }
        }

        // POPULEAZA FORMULARUL html CU DATELE FILTRAE SI PROCESATE
        function populateData(info) {
          $(info).find('Valute').each(function(){
              var CharCode = $(this).find('CharCode').text();
              if ((CharCode == "EUR") || (CharCode == "USD") || (CharCode == "RUB") || (CharCode == "RON")) {
                var Value = $(this).find('Value').text();

                selectedValue[ CharCode ] = Value;

              }
            });

          var datas = selectedValue;

          var allEl = $('[id^="curs_"]');
          $.each(allEl, function( index, value ) {
            //alert( index + ": " + value );
            var elID = $(this).attr('id');
            //console.log(elID);
            if (elID.indexOf("USD") >= 0) {
              $("#curs_USD").val(datas.USD);
            }
            if (elID.indexOf("EUR") >= 0) {
              $("#curs_EUR").val(datas.EUR);
            }
            if (elID.indexOf("RUB") >= 0) {
              $("#curs_RUB").val(datas.RUB);
            }
            if (elID.indexOf("RON") >= 0) {
              $("#curs_RON").val(datas.RON);
            }
          });

        }

        // ia datele de la BNM
        function GetDataFromUninorte(successCallback, errorCallback) {
            $('html').LoadingOverlay("show");

            var currentDate = new Date();
            var month=((currentDate.getMonth()+1)>=10)? (currentDate.getMonth()+1) : '0' + (currentDate.getMonth()+1);  
            var day=((currentDate.getDate())>=10)? (currentDate.getDate()) : '0' + (currentDate.getDate());
            var year = currentDate.getFullYear();

            var cursDate = day + "." + month + "." + year;

            var url = "https://cors-anywhere.herokuapp.com/https://bnm.md/ro/official_exchange_rates?get_xml=1&date=" + cursDate;
            $.ajax({
              type: "GET",
              url: url,
              dataType: "xml",
              success: mySuccessCallback,
              error: myErrorCallback
            });
        }

        // prelucreaza datele BNM daca succes
        function mySuccessCallback(successResponse) {
            console.log('callback:success', successResponse);
            
            populateData(successResponse);

            successResponse = XMLToString(successResponse);
            localforage.setItem('cursValutar', successResponse).then(function (value) {
                // Do other things once the value has been saved.
                console.log('Cache local salvat');
                console.log(value);
            }).catch(function(err) {
                // This code runs if there were any errors
                console.log('Cache local - eroare la salvare');
                console.log(err);
            });
            $('html').LoadingOverlay("hide", true);
        }

        // prelucreaza datele BNM daca eroare
        function myErrorCallback(successResponse) {
            console.log('callback:success', successResponse);
            GetDataFromUninorte(mySuccessCallback, myErrorCallback);
        }
        // GetDataFromUninorte(mySuccessCallback, myErrorCallback);


        var selectedValue = {};

        localforage.getItem('cursValutar').then(function(value) {
            // This code runs once the value has been loaded
            // from the offline store.
            console.log('Datele in cache exista');
            if (value == null) {
              GetDataFromUninorte(mySuccessCallback, myErrorCallback);
            } else {
              value = StringToXML(value);
              populateData(value);
            }
            console.log(value);
        }).catch(function(err) {
            // This code runs if there were any errors
            console.log('Datele in cache NU exista.Le luam de la BNM...');
            console.log(err);
            GetDataFromUninorte(mySuccessCallback, myErrorCallback);
        });

      var localCache = {
          data: {},
          remove: function (url) {
              delete localCache.data[url];
          },
          exist: function (url) {
              return localCache.data.hasOwnProperty(url) && localCache.data[url] !== null;
          },
          get: function (url) {
              console.log('Getting in cache for url' + url);
              return localCache.data[url];
          },
          set: function (url, cachedData, callback) {
              localCache.remove(url);
              localCache.data[url] = cachedData;
              if ($.isFunction(callback)) callback(cachedData);
          }
      };
        
        // log all IF doc ready remote data
        //console.log("doc ready");
      });
    </script>
  </body>
</html>